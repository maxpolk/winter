#! /bin/sh

#
# Tests for Winter, run as a top-level file.
#
# This file is part of Winter, a wiki-based computing platform.
# Copyright (C) 2012,2014  Max Polk <maxpolk@gmail.com>
# License located at http://www.gnu.org/licenses/agpl-3.0.html
#

#
# Code from:
# http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
#
# To capture return string:   DIR=$(ScriptDirectory)
# To echo to stdout:          ScriptDirectory
#
function ScriptDirectory
{
    local SOURCE="${BASH_SOURCE[0]}"
    local DIR="$( dirname "$SOURCE" )"
    while [ -h "$SOURCE" ]; do 
      SOURCE="$(readlink "$SOURCE")"
      [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
      DIR="$( cd -P "$( dirname "$SOURCE"  )" && pwd )"
    done
    DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

    echo $DIR
}

function Fail
{
    echo "$@"
    exit 1
}

DIR=$(ScriptDirectory)
cd "$DIR/.." || Fail "Unable to change directory $DIR/.."

# Default Python version which we assume is python 2
PY=$(hash python 2>/dev/null && hash -t python | head -1)
if [ ! -z "$PY" ]; then
    PY_FULL_VERSION=$($PY --version 2>&1)
    PY_VERSION=$($PY -c $'import sys\nprint (sys.version_info[0])\n' 2>&1)
    if [ ! "$PY_VERSION" = "2" ]; then
        echo "Expected Python version 2, but running $PY returned version 3"
        echo "Full version information: $PY_FULL_VERSION"
        exit 1
    fi
    echo "===================="
    echo "$PY_FULL_VERSION"
    echo "===================="
    $PY -m winter.test.tests -v
fi
